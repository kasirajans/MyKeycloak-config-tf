# User Management

This directory contains Terraform configurations for creating and managing users in Keycloak realms.

## ğŸ“ Structure

```
users/
â”œâ”€â”€ customer/              # Customer realm users
â”‚   â”œâ”€â”€ user.csv          # CSV: User data
â”‚   â””â”€â”€ main.tf           # Terraform: Create users
â”‚
â”œâ”€â”€ sp-customer/          # SP-Customer realm users
â”‚   â”œâ”€â”€ user.csv
â”‚   â””â”€â”€ main.tf
â”‚
â””â”€â”€ idp-customer/         # IdP-Customer realm users
    â”œâ”€â”€ user.csv
    â””â”€â”€ main.tf
```

## ğŸ¯ Purpose

Creates and manages users in Keycloak realms:
- Read user data from CSV files
- Auto-generate email addresses: `firstname.lastname@realm.com`
- Generate secure random passwords
- Create users with attributes
- Assign users to groups

## ğŸš€ Quick Start

### Deploy Users to IdP-Customer

```bash
cd idp-customer
terraform init
terraform apply -auto-approve

# View generated passwords
terraform output user_credentials
```

## ğŸ“ CSV Format

### user.csv

```csv
first_name,last_name,enabled,email_verified,temporary_password,groups
John,Doe,true,false,true,"developers,users"
Sarah,Miller,true,false,true,"managers,users"
Mike,Johnson,true,false,false,users
```

### Fields

- **first_name**: User's first name (required)
- **last_name**: User's last name (optional)
- **enabled**: true/false - Account enabled
- **email_verified**: true/false - Email verified status
- **temporary_password**: true/false - Force password change on first login
- **groups**: Comma-separated group names

### Email Generation

Email is auto-generated: `{first_name}.{last_name}@{realm}.com`

Examples:
- John Doe â†’ `john.doe@idp-customer.com`
- Sarah Miller â†’ `sarah.miller@idp-customer.com`
- Mike Johnson â†’ `mike.johnson@idp-customer.com`

## ğŸ”‘ Password Generation

Passwords are automatically generated with:
- **Length**: 16 characters
- **Requirements**: 
  - Minimum 1 uppercase letter
  - Minimum 1 lowercase letter
  - Minimum 1 digit
  - Minimum 1 special character (!@#$%^&*)
- **Secure**: Cryptographically random

## ğŸ“Š Viewing User Data

### Get All User Credentials
```bash
terraform output user_credentials
```

Output:
```json
{
  "john.doe@idp-customer.com": {
    "email": "john.doe@idp-customer.com",
    "groups": ["developers", "users"],
    "password": "N&&LC*h*n7lKFdC^",
    "temporary": false,
    "username": "john.doe@idp-customer.com"
  }
}
```

### Get Specific User Password
```bash
terraform output -json user_passwords | jq -r '.["john.doe@idp-customer.com"]'
```

### Get Complete User Credentials
```bash
terraform output -json user_credentials | jq -r '.["john.doe@idp-customer.com"]'
```

### Get All Passwords
```bash
terraform output -json user_passwords
```

### Get Groups
```bash
terraform output created_groups
```

## ğŸ“ Adding Users

### Add New User to CSV

1. Edit `user.csv`:
```csv
first_name,last_name,enabled,email_verified,temporary_password,groups
John,Doe,true,false,true,"developers,users"
Sarah,Miller,true,false,true,"managers,users"
Alice,Smith,true,false,true,"developers,users"  # NEW USER
```

2. Apply changes:
```bash
terraform apply
```

3. Get new user's password:
```bash
terraform output -json user_passwords | jq -r '.["alice.smith@idp-customer.com"]'
```

## ğŸ‘¥ Group Management

### Groups Are Auto-Created

Groups mentioned in CSV are automatically created:
```csv
John,Doe,true,false,true,"developers,users"
Sarah,Miller,true,false,true,"managers,users"
```

Creates groups: `developers`, `users`, `managers`

### Assign User to Multiple Groups

Use comma-separated list:
```csv
first_name,last_name,enabled,email_verified,temporary_password,groups
John,Doe,true,false,true,"developers,users,admins"
```

### No Groups

Leave empty:
```csv
first_name,last_name,enabled,email_verified,temporary_password,groups
Guest,User,true,false,false,
```

## ğŸ” Security Features

### Password Policy Compliance

Generated passwords meet default Keycloak policy:
- âœ… Minimum 8 characters
- âœ… At least 1 uppercase letter
- âœ… At least 1 digit
- âœ… Special characters supported

### Temporary Passwords

Set `temporary_password: true` to force password change on first login:
```csv
first_name,last_name,enabled,email_verified,temporary_password,groups
John,Doe,true,false,true,"users"
```

User must change password after first login.

### Secure Storage

Passwords are:
- âŒ Never stored in CSV
- âœ… Generated by Terraform
- âœ… Stored in Terraform state (encrypted if using remote backend)
- âœ… Marked as sensitive in outputs

## ğŸ” Verification

### Check Users in Keycloak Console

1. Login: http://localhost:8080/admin
2. Switch to realm (e.g., `idp-customer`)
3. Navigate to **Users**
4. Verify users are created

### Test User Login

1. Go to realm login: `http://localhost:8080/realms/idp-customer/account`
2. Login with:
   - Username: `john.doe@idp-customer.com`
   - Password: (from terraform output)
3. Change password if temporary

## ğŸ“Š User Attributes

Users are created with:
```
Username: email address
Email: auto-generated
Email Verified: from CSV
First Name: from CSV
Last Name: from CSV
Enabled: from CSV
Initial Password: auto-generated
Groups: from CSV
```

## ğŸ› ï¸ Common Tasks

### Disable a User

Edit CSV:
```csv
first_name,last_name,enabled,email_verified,temporary_password,groups
John,Doe,false,false,true,"users"  # Changed to false
```

Then: `terraform apply`

### Change User Groups

Edit CSV:
```csv
first_name,last_name,enabled,email_verified,temporary_password,groups
John,Doe,true,false,true,"admins,users"  # Added admins group
```

Then: `terraform apply`

### Reset User Password

Remove user from state and re-create:
```bash
terraform state rm 'keycloak_user.users["john.doe@idp-customer.com"]'
terraform apply
terraform output -json user_passwords | jq -r '.["john.doe@idp-customer.com"]'
```

### Remove a User

Remove from CSV and apply:
```bash
# Edit user.csv - delete the row
terraform apply
```

## ğŸ”„ Sync with Identity Provider

When using identity federation:
- Users in **IdP-Customer**: Manage here (CSV)
- Users in **SP-Customer**: Auto-created on first login from IdP
- User data synced based on IdP `sync_mode` setting

## ğŸ”— Related

- **Realms**: See `config/realm/` for realm configuration
- **Clients**: See `app/` for client configurations
- **IdP**: See `config/idp-provider/` for federation setup
- **Main README**: See root `README.md` for complete flow

---

See root README.md for complete architecture and user flow details.
